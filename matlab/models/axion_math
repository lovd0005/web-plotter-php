#!/usr/local/bin/math -script

p = ToExpression[$CommandLine[[4]]];
ξcmb = ToExpression[$CommandLine[[5]]];
Ncmb = ToExpression[$CommandLine[[6]]];
num  = ToExpression[$CommandLine[[7]]];
ξval = 4; 
Nval = 3; 

ll = {0, 0, 0.1, 0.0486206, 0.2, 0.00849174, 0.3, 
    0.0023942, 0.4, 0.000884513, 0.5, 0.000386489, 0.6, 0.000189319, 0.7, 
    0.000100792, 0.8, 0.0000571987, 0.9, 0.0000341516, 1., 0.0000212572, 
    1.1, 0.0000137004, 1.2, 9.09631*^-6, 1.3, 6.19665*^-6, 1.4, 4.31735*^-6, 
    1.5, 3.06843*^-6, 1.6, 2.21982*^-6, 1.7, 1.6317*^-6, 1.8, 1.21679*^-6, 
    1.9, 9.19349*^-7, 2., 7.02973*^-7, 2.1, 5.43454*^-7, 2.2, 4.24402*^-7, 
    2.3, 3.34541*^-7, 2.4, 2.66003*^-7, 2.5, 2.13216*^-7, 2.6, 1.72195*^-7, 
    2.7, 1.40047*^-7, 2.8, 1.14652*^-7, 2.9, 9.44451*^-8, 3., 7.82532*^-8, 
    3.1, 6.51935*^-8, 3.2, 5.45955*^-8, 3.3, 4.59445*^-8, 3.4, 3.8844*^-8, 
    3.5, 3.29857*^-8, 3.6, 2.81282*^-8, 3.7, 2.40816*^-8, 3.8, 2.06952*^-8, 
    3.9, 1.78493*^-8, 4., 1.54478*^-8, 4.1, 1.34134*^-8, 4.2, 1.16837*^-8, 
    4.3, 1.02078*^-8, 4.4, 8.94395*^-9, 4.5, 7.85837*^-9, 4.6, 6.92289*^-9, 
    4.7, 6.11428*^-9, 4.8, 5.41343*^-9, 4.9, 4.80419*^-9, 5., 4.27325*^-9, 
    5.1, 3.80926*^-9, 5.2, 3.40282*^-9, 5.3, 3.046*^-9, 5.4, 2.73185*^-9, 
    5.5, 2.4548*^-9, 5.6, 2.20988*^-9, 5.7, 1.99294*^-9, 5.8, 1.80036*^-9, 
    5.9, 1.62911*^-9, 6., 1.47651*^-9, 6.1, 1.34026*^-9, 6.2, 1.21843*^-9, 
    6.3, 1.10928*^-9, 6.4, 1.01139*^-9, 6.5, 9.23369*^-10, 6.6, 
    8.44143*^-10, 6.7, 7.72708*^-10, 6.8, 7.08245*^-10, 6.9, 6.49913*^-10, 
    7., 5.97135*^-10}; 
len = Length[ll]/2; 
f2 = Interpolation[Table[{ll[[2*(i - 1) + 1]], ll[[2*(i - 1) + 2]]}, 
     {i, 1, len}]]; ll = {0.1, 0.000416532, 0.2, 0.0000909293, 0.3, 
    0.0000227817, 0.4, 6.78701*^-6, 0.5, 2.32452*^-6, 0.6, 8.889*^-7, 0.7, 
    3.71465*^-7, 0.8, 1.66996*^-7, 0.9, 7.98217*^-8, 1., 4.02025*^-8, 1.1, 
    2.11848*^-8, 1.2, 1.1614*^-8, 1.3, 6.59336*^-9, 1.4, 3.86136*^-9, 1.5, 
    2.32532*^-9, 1.6, 1.436*^-9, 1.7, 9.07258*^-10, 1.8, 5.85244*^-10, 1.9, 
    3.84776*^-10, 2., 2.57437*^-10, 2.1, 1.75038*^-10, 2.2, 1.208*^-10, 2.3, 
    8.45288*^-11, 2.4, 5.99139*^-11, 2.5, 4.2979*^-11, 2.6, 3.11781*^-11, 
    2.7, 2.28559*^-11, 2.8, 1.69209*^-11, 2.9, 1.26435*^-11, 3., 
    9.53008*^-12, 3.1, 7.24264*^-12, 3.2, 5.54716*^-12, 3.3, 4.27995*^-12, 
    3.4, 3.32532*^-12, 3.5, 2.60075*^-12, 3.6, 2.04687*^-12, 3.7, 
    1.62061*^-12, 3.8, 1.29045*^-12, 3.9, 1.03314*^-12, 4., 8.31441*^-13, 
    4.1, 6.72438*^-13, 4.2, 5.46428*^-13, 4.3, 4.46049*^-13, 4.4, 
    3.65698*^-13, 4.5, 3.01075*^-13, 4.6, 2.48866*^-13, 4.7, 2.06505*^-13, 
    4.8, 1.7199*^-13, 4.9, 1.43756*^-13, 5., 1.20571*^-13, 5.1, 1.0146*^-13, 
    5.2, 8.56525*^-14, 5.3, 7.25308*^-14, 5.4, 6.16031*^-14, 5.5, 
    5.24731*^-14, 5.6, 4.48212*^-14, 5.7, 3.83889*^-14, 5.8, 3.29661*^-14, 
    5.9, 2.83813*^-14, 6., 2.44946*^-14, 6.1, 2.11908*^-14, 6.2, 
    1.83754*^-14, 6.3, 1.59701*^-14, 6.4, 1.39104*^-14, 6.5, 1.21423*^-14, 
    6.6, 1.06211*^-14, 6.7, 9.30941*^-15, 6.8, 8.17595*^-15, 6.9, 
    7.19444*^-15, 7., 6.34276*^-15}; 
len = Length[ll]/2; 
f3 = Interpolation[Table[{ll[[2*(i - 1) + 1]], ll[[2*(i - 1) + 2]]}, 
     {i, 1, len}]]; ll = {0.1, 0.0679753, 0.2, 0.000945413, 0.3, 
    0.0000988398, 0.4, 0.0000219949, 0.5, 7.09343*^-6, 0.6, 2.83665*^-6, 
    0.7, 1.30519*^-6, 0.8, 6.63228*^-7, 0.9, 3.63065*^-7, 1., 2.10684*^-7, 
    1.1, 1.28157*^-7, 1.2, 8.1059*^-8, 1.3, 5.29875*^-8, 1.4, 3.5633*^-8, 
    1.5, 2.45583*^-8, 1.6, 1.72954*^-8, 1.7, 1.24158*^-8, 1.8, 9.06672*^-9, 
    1.9, 6.72378*^-9, 2., 5.05618*^-9, 2.1, 3.85063*^-9, 2.2, 2.96668*^-9, 
    2.3, 2.31007*^-9, 2.4, 1.81648*^-9, 2.5, 1.44134*^-9, 2.6, 1.15332*^-9, 
    2.7, 9.30078*^-10, 2.8, 7.55527*^-10, 2.9, 6.17925*^-10, 3., 
    5.08615*^-10, 3.1, 4.21153*^-10, 3.2, 3.507*^-10, 3.3, 2.93588*^-10, 
    3.4, 2.47009*^-10, 3.5, 2.08807*^-10, 3.6, 1.77307*^-10, 3.7, 
    1.512*^-10, 3.8, 1.2946*^-10, 3.9, 1.11272*^-10, 4., 9.5989*^-11, 4.1, 
    8.30953*^-11, 4.2, 7.2173*^-11, 4.3, 6.2886*^-11, 4.4, 5.49608*^-11, 
    4.5, 4.81745*^-11, 4.6, 4.23438*^-11, 4.7, 3.73185*^-11, 4.8, 
    3.29743*^-11, 4.9, 2.92075*^-11, 5., 2.59325*^-11, 5.1, 2.30772*^-11, 
    5.2, 2.05814*^-11, 5.3, 1.83944*^-11, 5.4, 1.64733*^-11, 5.5, 
    1.47819*^-11, 5.6, 1.32893*^-11, 5.7, 1.19694*^-11, 5.8, 1.07997*^-11, 
    5.9, 9.761*^-12, 6., 8.83685*^-12, 6.1, 8.01303*^-12, 6.2, 7.27733*^-12, 
    6.3, 6.61912*^-12, 6.4, 6.02923*^-12, 6.5, 5.4997*^-12, 6.6, 
    5.02358*^-12, 6.7, 4.59478*^-12, 6.8, 4.20805*^-12, 6.9, 3.85873*^-12, 
    7., 3.5427*^-12}; 
len = Length[ll]/2; 
fhL = Interpolation[Table[{ll[[2*(i - 1) + 1]], ll[[2*(i - 1) + 2]]}, 
     {i, 1, len}]]; If[p == 1, ll = {1.2, 45, 9.27797, 35.6551, 35.3776, 
     1.2, 55, 10.2571, 41.7444, 28.8518, 1.2, 65, 11.1506, 47.5769, 26.4982, 
     1.7, 45, 9.06413, 38.0822, 37.7538, 1.7, 55, 10.0183, 44.6307, 29.711, 
     1.7, 65, 10.8891, 50.9031, 27.0902, 2.2, 45, 8.77409, 40.6999, 40.3317, 
     2.2, 55, 9.69595, 47.7182, 31.0455, 2.2, 65, 10.5375, 54.4407, 27.9962, 
     2.7, 45, 8.43598, 43.1932, 42.7933, 2.7, 55, 9.32107, 50.6483, 32.5788, 
     2.7, 65, 10.1293, 57.2655, 29.1672}, 
   ll = {1.2, 45, 13.222, 16.8354, 16.5926, 1.2, 55, 14.606, 19.185, 
     10.6952, 1.2, 65, 15.87, 21.3778, 8.99177, 1.7, 45, 12.952, 19.6716, 
     19.3197, 1.7, 55, 14.304, 22.5562, 11.2865, 1.7, 65, 15.538, 25.2478, 
     9.35868, 2.2, 45, 12.571, 22.9036, 22.4692, 2.2, 55, 13.88, 26.3284, 
     12.298, 2.2, 65, 15.076, 29.5289, 9.95092, 2.7, 45, 12.114, 26.0979, 
     25.5887, 2.7, 55, 13.375, 30.0349, 13.5586, 2.7, 65, 14.525, 33.7083, 
     10.7773}]; 
len = Length[ll]/5; 

Do[ξtab[i] = ll[[5*Nval*(i - 1) + 1]], {i, 1, ξval}]
Do[Ntab[i] = ll[[5*(i - 1) + 2]], {i, 1, Nval}]
Do[{yintab[i, j] = ll[[5*Nval*(i - 1) + 5*(j - 1) + 3]], 
   tendtab[i, j] = ll[[5*Nval*(i - 1) + 5*(j - 1) + 4]], 
   t100tab[i, j] = ll[[5*Nval*(i - 1) + 5*(j - 1) + 5]]}, {j, 1, Nval}, 
  {i, 1, ξval}]

ival = 0; 
Do[If[ξcmb > ξtab[i], ival = i], {i, 1, ξval}]; 
If[ξcmb == ξtab[ξval], ival = ξval]; 
jval = 0; 
Do[If[Ncmb > Ntab[i], jval = i], {i, 1, Nval}]; 
If[Ncmb == Ntab[Nval], jval = Nval]; 
done = 0; 
If[ival < 1 && jval < 1, {yinguess = yintab[1, 1], 
    tendguess = tendtab[1, 1], t100guess = t100tab[1, 1], done = 1}]; 
If[done == 0 && ival < 1 && jval < Nval, 
   {Y1 = Ntab[jval]; Y2 = Ntab[jval + 1]; F1 = yintab[1, jval]; 
     F2 = yintab[1, jval + 1]; yinguess = 
      F1 + ((F2 - F1)/(Y2 - Y1))*(Ncmb - Y1), F1 = tendtab[1, jval]; 
     F2 = tendtab[1, jval + 1]; tendguess = 
      F1 + ((F2 - F1)/(Y2 - Y1))*(Ncmb - Y1), F1 = t100tab[1, jval]; 
     F2 = t100tab[1, jval + 1]; t100guess = 
      F1 + ((F2 - F1)/(Y2 - Y1))*(Ncmb - Y1), done = 2}]; 
If[done == 0 && ival < 1, {yinguess = yintab[1, Nval], 
    tendguess = tendtab[1, Nval], t100guess = t100tab[1, Nval], done = 3}]; 
If[done == 0 && ival < ξval && jval < 1, 
   {X1 = ξtab[ival]; X2 = ξtab[ival + 1]; F1 = yintab[ival, 1]; 
     F2 = yintab[ival + 1, 1]; yinguess = 
      F1 + ((F2 - F1)/(X2 - X1))*(ξcmb - X1), F1 = tendtab[ival, 1]; 
     F2 = tendtab[ival + 1, 1]; tendguess = 
      F1 + ((F2 - F1)/(X2 - X1))*(ξcmb - X1), F1 = t100tab[ival, 1]; 
     F2 = t100tab[ival + 1, 1]; t100guess = 
      F1 + ((F2 - F1)/(X2 - X1))*(ξcmb - X1), done = 4}]; 
If[done == 0 && ival < ξval && jval < Nval, {X1 = ξtab[ival], 
    X2 = ξtab[ival + 1], Y1 = Ntab[jval], Y2 = Ntab[jval + 1], 
    F11 = yintab[ival, jval], F12 = yintab[ival, jval + 1], 
    F21 = yintab[ival + 1, jval], F22 = yintab[ival + 1, jval + 1], 
    yinguess = ((F22*(-Ncmb + Y1) + F21*(Ncmb - Y2))*(X1 - ξcmb) + 
       F12*(Ncmb - Y1)*(X2 - ξcmb) + F11*(Ncmb - Y2)*(-X2 + ξcmb))/
      ((X1 - X2)*(Y1 - Y2)), F11 = tendtab[ival, jval], 
    F12 = tendtab[ival, jval + 1], F21 = tendtab[ival + 1, jval], 
    F22 = tendtab[ival + 1, jval + 1], tendguess = 
     ((F22*(-Ncmb + Y1) + F21*(Ncmb - Y2))*(X1 - ξcmb) + 
       F12*(Ncmb - Y1)*(X2 - ξcmb) + F11*(Ncmb - Y2)*(-X2 + ξcmb))/
      ((X1 - X2)*(Y1 - Y2)), F11 = t100tab[ival, jval], 
    F12 = t100tab[ival, jval + 1], F21 = t100tab[ival + 1, jval], 
    F22 = t100tab[ival + 1, jval + 1], t100guess = 
     ((F22*(-Ncmb + Y1) + F21*(Ncmb - Y2))*(X1 - ξcmb) + 
       F12*(Ncmb - Y1)*(X2 - ξcmb) + F11*(Ncmb - Y2)*(-X2 + ξcmb))/
      ((X1 - X2)*(Y1 - Y2)), done = 5}]; 
If[done == 0 && ival < ξval, {X1 = ξtab[ival]; X2 = ξtab[ival + 1]; 
     F1 = yintab[ival, Nval]; F2 = yintab[ival + 1, Nval]; 
     yinguess = F1 + ((F2 - F1)/(X2 - X1))*(ξcmb - X1), 
    F1 = tendtab[ival, Nval]; F2 = tendtab[ival + 1, Nval]; 
     tendguess = F1 + ((F2 - F1)/(X2 - X1))*(ξcmb - X1), 
    F1 = t100tab[ival, Nval]; F2 = t100tab[ival + 1, Nval]; 
     t100guess = F1 + ((F2 - F1)/(X2 - X1))*(ξcmb - X1), done = 6}]; 
If[done == 0 && jval < 1, {yinguess = yintab[ξval, 1], 
    tendguess = tendtab[ξval, 1], t100guess = t100tab[ξval, 1], 
    done = 7}]; 
If[done == 0 && jval < Nval, {Y1 = Ntab[jval]; Y2 = Ntab[jval + 1]; 
     F1 = yintab[ξval, jval]; F2 = yintab[ξval, jval + 1]; 
     yinguess = F1 + ((F2 - F1)/(Y2 - Y1))*(Ncmb - Y1), 
    F1 = tendtab[ξval, jval]; F2 = tendtab[ξval, jval + 1]; 
     tendguess = F1 + ((F2 - F1)/(Y2 - Y1))*(Ncmb - Y1), 
    F1 = t100tab[ξval, jval]; F2 = t100tab[ξval, jval + 1]; 
     t100guess = F1 + ((F2 - F1)/(Y2 - Y1))*(Ncmb - Y1), done = 8}]; 
If[done == 0, {yinguess = yintab[ξval, Nval], 
    tendguess = tendtab[ξval, Nval], t100guess = t100tab[ξval, Nval], 
    done = 9}]; 
Do[{tin = 0, tend = tendguess + 2, ϕin[1] = yinguess + 0.01, 
   ϕin[2] = yinguess - 0.01, ϕin[3] = yinguess, 
   Do[{yin = ϕin[ii], Psnum = 2.445/10^9, 
     parA = (1 + p^2/(6*yin^2))^2*((yin^(2 + p)*f2[ξcmb]*E^(4*Pi*ξcmb))/
        (12*Pi^2*p^3)), parC = (1/(1 + p^2/(6*yin^2))^2)*
       ((12*Pi^2*p^3*Psnum)/yin^(2 + p)), 
     parM = (-1 + Sqrt[1 + 4*parA*parC])/(2*parA), 
     zin = (-Sqrt[p/3])*(1/yin^(1 - p/2)), ain = 1, 
     hhin = (yin^(p/2)/Sqrt[3*p])*Sqrt[1 + p^2/(6*yin^2)], 
     hh = Sqrt[z[t]^2/6 + Abs[y[t]]^p/(3*p)], 
     ξξ = ξcmb*(z[t]/zin)*(hhin/hh), eq1 = Derivative[1][y][t] - z[t], 
     eq2 = Derivative[1][z][t] + 3*hh*z[t] + Sign[y[t]]*Abs[y[t]]^(p - 1) - 
       (((2*yin*ξcmb)/p)*Sqrt[1 + p^2/(6*yin^2)]*2.4*parM*(hh^4/ξξ^4)*
         Exp[2*Pi*ξξ])/10^4, eq3 = Derivative[1][a][t] - hh*a[t], 
     sol = NDSolve[{eq1 == 0, eq2 == 0, eq3 == 0, y[tin] == yin, 
         z[tin] == zin, a[tin] == ain}, {y[t], z[t], a[t]}, {t, tin, tend}][[
       1]], add[t_] = (1/3)*(Abs[y[t]]^p/p - z[t]^2) + 
        (2.4*((ξcmb*yin*parM)/(3*p))*Sqrt[1 + p^2/(6*yin^2)]*z[t]*
          (hh^3/ξξ^4)*Exp[2*Pi*ξξ])/10^4 /. sol, 
     tstar = Quiet[FindRoot[add[x] == 0, {x, tendguess}][[1,2]]], 
     efolds[ii] = Log[a[t] /. sol /. t -> tstar]}, {ii, 1, 3}], 
   yinguess = yinguess + (2*0.01*(Ncmb - efolds[3]))/
      (efolds[1] - efolds[2]), tendguess = tstar}, {iter, 1, 10}]

eft[t_] = Log[a[t] /. sol]; 
ξt[t_] = ξξ /. sol; 
ht[t_] = hh /. sol; 
freq[t_] = 100*Exp[eft[t] - 44.91]; 

omegaGW[t_] = (3.55*parM*ht[t]^2*(1 + parM*ht[t]^2*fhL[ξt[t]]*Exp[4*Pi*ξt[t]]))/10^7; 

t100 = FindRoot[eft[t] == 44.91, {t, t100guess}][[1,2]]; 

If[freq[tend] < 10^4, tstop = tend, 
  tstop = FindRoot[freq[t] == 10^4,
  {t, tend}][[1,2]]];

Do[point[i] = tin*(tstop/tin)^((i - 1)/(num - 1)), {i, 1, num}]; 

tabout3 = Table[{freq[point[i]], omegaGW[point[i]]}, {i, 1, num}]; 

Export["matlab/axion_dat/output.dat", tabout3,"TABLE"]
